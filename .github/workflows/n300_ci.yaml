name: Tenstorrent N300 CI

on:
  push:
    branches: [ main, dev ]
    paths:
      - 'kernels/**'
      - 'tests/**'
      - 'CMakeLists.txt'
      - 'requirements.txt'
  pull_request:
    branches: [ main ]

env:
  ARCH_NAME: wormhole_b0
  TT_METAL_HOME: /opt/tt-metal

jobs:
  validate-config:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Validate test config
        run: |
          python3 -c "
          import json
          with open('tests/test_config.json') as f:
              config = json.load(f)
          assert 'tests' in config, 'Missing tests array'
          for test in config['tests']:
              assert 'name' in test
              assert 'kernel_path' in test
              assert 'wavelet' in test
              assert 'dim' in test
              assert 'shape' in test
              assert 'atol' in test
          print('✓ Config validation passed')
          "

  build-and-test:
    needs: validate-config
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Deploy and Test on Koyeb N300
        uses: appleboy/ssh-action@master
        with:
          host: 01.proxy.koyeb.app
          port: 12045
          username: root
          key: ${{ secrets.KOYEB_SSH_KEY }}
          command_timeout: 25m
          script: |
            set -e
            
            # for stylish output
            RED='\033[0;31m'
            GREEN='\033[0;32m'
            YELLOW='\033[1;33m'
            NC='\033[0m'

            cd ~/tt-wavelet || { echo -e "${RED}Project directory not found${NC}"; exit 1; }

            git fetch origin
            git reset --hard origin/${{ github.ref_name }}

            echo -e "${YELLOW}[3/7] Setting up Python environment...${NC}"
            python3 -m venv .venv
            source .venv/bin/activate
            pip install --upgrade pip wheel setuptools
            pip install -r requirements.txt
            pre-commit install

            echo -e "${YELLOW} Building kernels...${NC}"
            rm -rf build
            mkdir -p build && cd build
            cmake -DCMAKE_BUILD_TYPE=Release ..
            make -j$(nproc) || { echo -e "${RED}Build failed${NC}"; exit 1; }
            cd ..

            echo -e "${YELLOW}Setting up TT-Metal environment...${NC}"
            if [ -f /opt/tt-metal/setup_env.sh ]; then
              source /opt/tt-metal/setup_env.sh
            else
              echo -e "${RED}TT-Metal environment not found${NC}"
              exit 1
            fi
            export ARCH_NAME=wormhole_b0

            echo -e "${YELLOW}Checking device availability...${NC}"
            python3 -c "
            import ttnn
            device = ttnn.open_device(device_id=0)
            print(f'Device available: {device}')
            ttnn.close_device(device)
            " || { echo -e "${RED}Device check failed${NC}"; exit 1; }

            echo -e "${YELLOW}Running tests...${NC}"
            cd tests
            python3 test_runner.py --config test_config.json --verbose
            
            TEST_EXIT_CODE=$?
            
            if [ $TEST_EXIT_CODE -eq 0 ]; then
              echo -e "${GREEN}✓ All tests passed!${NC}"
            else
              echo -e "${RED}✗ Tests failed with exit code $TEST_EXIT_CODE${NC}"
              exit $TEST_EXIT_CODE
            fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results
          path: |
            tests/results/*.json
            tests/results/*.log
          retention-days: 30